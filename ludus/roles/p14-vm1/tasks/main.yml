- name: Get network prefix from Windows
  win_shell: |
    $ip = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.IPAddress -match '^10\.' -or $_.IPAddress -match '^192\.168\.' -or $_.IPAddress -match '^172\.' } | Select-Object -First 1).IPAddress
    $prefix = $ip -replace '\.[0-9]+$', ''
    Write-Output $prefix
  register: network_result

- name: Set network prefix fact
  set_fact:
    network_prefix: "{{ network_result.stdout | trim }}"

- name: Wait for SCADA Server (VM2) to be reachable
  wait_for:
    host: "{{ network_prefix }}.10"
    port: 3389
    state: started
    timeout: 300 # Wait up to 5 minutes
  delegate_to: localhost # Run this check from the Ansible controller, not VM1

- name: Create 'technicien' user (Phishing Target)
  win_user:
    name: technicien
    password: "SecureP14-2024@!"
    groups:
      - Users
    state: present

- name: Create 'it.admin' user
  win_user:
    name: it.admin
    password: "SecureP14-2024@!"
    groups:
      - Administrators
    state: present

- name: Grant batch logon rights to users
  win_user_right:
    name: SeBatchLogonRight
    users:
      - technicien
      - it.admin
    action: add

- name: Disable Windows Defender Real-time Monitoring
  win_shell: Set-MpPreference -DisableRealtimeMonitoring $true

- name: Disable Firewall (All Profiles)
  win_shell: Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

- name: Disable UAC
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableLUA
    data: 0
    type: dword

- name: Set PowerShell Execution Policy to Unrestricted
  win_shell: Set-ExecutionPolicy Unrestricted -Force

# Automating the stored RDP credential (Cmdkey)
- name: Save SCADA Credentials for 'technicien'
  win_shell: |
    cmdkey /generic:"TERMSRV/{{ network_prefix }}.10" /user:"scada_user" /pass:"Secure2024@!"
  become: yes
  become_user: technicien
  become_method: runas

# --- OpenBAS Agent Installation (per-user session) ---
- name: Install OpenBAS Agent for technicien
  win_shell: |
    iex (iwr -UseBasicParsing {{ openbas_url }}/api/agent/installer/openaev/windows/session-user/{{ agent_token }}).Content
  become: yes
  become_user: technicien
  become_method: runas
  ignore_errors: yes