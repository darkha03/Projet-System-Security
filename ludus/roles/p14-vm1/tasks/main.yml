- name: Wait for SCADA Server (VM2) to be reachable
  wait_for:
    host: 10.0.0.10
    port: 3389
    state: started
    timeout: 300 # Wait up to 5 minutes
  delegate_to: localhost # Run this check from the Ansible controller, not VM1

- name: Create 'technicien' user (Phishing Target)
  win_user:
    name: technicien
    password: "Tech2024!"
    groups:
      - Utilisateurs
    state: present

- name: Create 'it.admin' user
  win_user:
    name: it.admin
    password: "ITAdmin2024!"
    groups:
      - Administrateurs
    state: present

- name: Disable Windows Defender Real-time Monitoring
  win_shell: Set-MpPreference -DisableRealtimeMonitoring $true

- name: Disable Firewall (All Profiles)
  win_shell: Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

- name: Disable UAC
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableLUA
    data: 0
    type: dword

# Automating the stored RDP credential (Cmdkey)
- name: Save SCADA Credentials for 'technicien'
  win_shell: |
    cmdkey /generic:"TERMSRV/10.0.0.10" /user:"scada_user" /pass:"Secure2024@!"
  become: yes
  become_user: technicien
  become_method: runas

# --- OpenBAS Agent Installation ---
- name: Create OpenBAS directory
  win_file:
    path: C:\OpenBAS
    state: directory

- name: Download OpenBAS Agent
  win_get_url:
    url: "{{ openbas_url }}/api/agent/installer/windows"
    dest: C:\OpenBAS\openbas-agent-installer.exe
    headers:
      Authorization: "Bearer {{ agent_token }}"
  ignore_errors: yes

- name: Install OpenBAS Agent
  win_shell: |
    Start-Process -FilePath "C:\OpenBAS\openbas-agent-installer.exe" -ArgumentList "/S" -Wait
  ignore_errors: yes

- name: Configure OpenBAS Agent
  win_shell: |
    $configPath = "C:\Program Files\OpenBAS\config.json"
    $config = @{
      server_url = "{{ openbas_url }}"
      agent_token = "{{ agent_token }}"
      hostname = "{{ ansible_hostname }}"
    } | ConvertTo-Json
    $config | Out-File -FilePath $configPath -Encoding UTF8
  ignore_errors: yes

- name: Start OpenBAS Agent Service
  win_service:
    name: OpenBASAgent
    state: started
    start_mode: auto
  ignore_errors: yes