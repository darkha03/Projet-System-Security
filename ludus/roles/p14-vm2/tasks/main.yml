# roles/p14-vm2/tasks/main.yml

# --- 1. Basic Setup ---
- name: Create Users
  win_user:
    name: "{{ item.name }}"
    password: "{{ item.pass }}"
    groups: "{{ item.groups }}"
  loop:
    - { name: 'scada_user', pass: 'Secure2024@!', groups: ['Users', 'Remote Desktop Users'] }
    - { name: 'scada_admin', pass: 'SecureP14-2024!', groups: ['Administrators'] }

- name: Grant batch logon rights to users
  win_user_right:
    name: SeBatchLogonRight
    users:
      - scada_user
      - scada_admin
    action: add

- name: Install IIS
  win_feature:
    name: Web-Server
    include_management_tools: yes
    state: present

# --- 2. Install Python ---
- name: Download Python Installer
  win_get_url:
    url: https://www.python.org/ftp/python/3.12.2/python-3.12.2-amd64.exe
    dest: C:\Windows\Temp\python-installer.exe

- name: Install Python
  win_shell: C:\Windows\Temp\python-installer.exe /quiet InstallAllUsers=1 PrependPath=1


- name: Install Python Dependencies
  win_shell: |
    $env:Path = [System.Environment]::GetEnvironmentVariable('Path','Machine')
    pip install pymodbus flask flask-cors
  retries: 3
  delay: 10
  register: pip_install
  until: pip_install is succeeded

# --- 3. Setup SCADA Files ---
- name: Create Directories
  win_file:
    path: "{{ item }}"
    state: directory
  loop:
    - C:\SCADA\HMI\api
    - C:\SCADA\HMI\web
    - C:\SCADA\HMI\logs
    - C:\SCADA\Data\Patients
    - C:\SCADA\Data\Research
    - C:\SCADA\Data\Formulas
    - C:\SCADA\Data\Calibration
    - C:\Tools

# NOTE: Put your provided scada_api.py and index.html in the 'files' folder of this role!
- name: Copy SCADA Source Files
  win_copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - { src: 'scada_api.py', dest: 'C:\SCADA\HMI\api\scada_api.py' }
    - { src: 'index.html', dest: 'C:\inetpub\wwwroot\index.html' }

# --- 4. Setup Service (NSSM) ---
- name: Install NSSM
  win_chocolatey:
    name: nssm
    state: present

- name: Create SCADA Service
  win_shell: |
    $service = Get-Service -Name SCADA_API -ErrorAction SilentlyContinue
    if (-not $service) {
      nssm install SCADA_API 'C:\Program Files\Python312\python.exe'
      nssm set SCADA_API AppParameters 'C:\SCADA\HMI\api\scada_api.py'
      nssm set SCADA_API DisplayName 'SCADA HMI API Service'
      nssm set SCADA_API Description 'BioTech Solutions - SCADA Modbus API Server'
      nssm set SCADA_API AppDirectory 'C:\SCADA\HMI\api'
      nssm set SCADA_API Start SERVICE_AUTO_START
      nssm set SCADA_API AppStdout 'C:\SCADA\HMI\logs\api_stdout.log'
      nssm set SCADA_API AppStderr 'C:\SCADA\HMI\logs\api_stderr.log'
    }
  ignore_errors: yes

- name: Start SCADA Service
  win_service:
    name: SCADA_API
    state: started
  retries: 3
  delay: 5
  register: service_start
  until: service_start is succeeded
  ignore_errors: yes


# --- 5. Firewall Rules (CRITICAL) ---
- name: Get network prefix from Windows
  win_shell: |
    $ip = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.IPAddress -match '^10\.' -or $_.IPAddress -match '^192\.168\.' -or $_.IPAddress -match '^172\.' } | Select-Object -First 1).IPAddress
    $prefix = $ip -replace '\.[0-9]+$', ''
    Write-Output $prefix
  register: network_result

- name: Set network prefix fact
  set_fact:
    network_prefix: "{{ network_result.stdout | trim }}"

- name: Apply Firewall Rules Inbound
  win_shell: |
    $prefix = '{{ network_prefix }}'
    # Allow Ping
    if (-not (Get-NetFirewallRule -DisplayName 'P14-Allow-Ping' -ErrorAction SilentlyContinue)) {
      New-NetFirewallRule -DisplayName 'P14-Allow-Ping' -Direction Inbound -Protocol ICMPv4 -Action Allow
    }
    # Allow RDP from VM1
    if (-not (Get-NetFirewallRule -DisplayName 'P14-Allow-VM1' -ErrorAction SilentlyContinue)) {
      New-NetFirewallRule -DisplayName 'P14-Allow-VM1' -Direction Inbound -Protocol TCP -LocalPort 3389 -RemoteAddress "$prefix.45" -Action Allow
    }
    # Block IT Zone (except VM1)
    if (-not (Get-NetFirewallRule -DisplayName 'P14-Block-IT-Zone' -ErrorAction SilentlyContinue)) {
      New-NetFirewallRule -DisplayName 'P14-Block-IT-Zone' -Direction Inbound -Action Block -Protocol TCP -LocalPort 80,443,502,3389,445 -RemoteAddress "$prefix.40-$prefix.44,$prefix.46-$prefix.50"
    }
    # Allow API
    if (-not (Get-NetFirewallRule -DisplayName 'P14-Allow-API' -ErrorAction SilentlyContinue)) {
      New-NetFirewallRule -DisplayName 'P14-Allow-API' -Direction Inbound -Protocol TCP -LocalPort 5000 -Action Allow
    }

- name: Apply Firewall Rules Outbound Modbus
  win_shell: |
    # Block Modbus for PowerShell
    if (-not (Get-NetFirewallRule -DisplayName 'P14-Block-Modbus-PowerShell' -ErrorAction SilentlyContinue)) {
      New-NetFirewallRule -DisplayName 'P14-Block-Modbus-PowerShell' -Direction Outbound -Protocol TCP -RemotePort 502 -Program 'C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe' -Action Block
    }
    # Block Modbus for CMD
    if (-not (Get-NetFirewallRule -DisplayName 'P14-Block-Modbus-CMD' -ErrorAction SilentlyContinue)) {
      New-NetFirewallRule -DisplayName 'P14-Block-Modbus-CMD' -Direction Outbound -Protocol TCP -RemotePort 502 -Program 'C:\Windows\System32\cmd.exe' -Action Block
    }

# --- 6. Vulnerabilities & Fake Data ---
- name: Generate Fake Data - Patients (~15 MB)
  win_shell: |
    1..500 | ForEach-Object {
      $id = $_
      $content = "CONFIDENTIEL - DOSSIER PATIENT`n"
      $content += "Patient ID: PAT-$id`n"
      $content += "Date: $(Get-Date)`n"
      $content += "Donnees medicales:`n"
      $content += (1..3000 | ForEach-Object { "Mesure $($_) - $((Get-Random -Maximum 9999)/100)" }) -join "`n"
      $content | Out-File "C:\SCADA\Data\Patients\patient_$id.dat" -Encoding UTF8
    }

- name: Generate Fake Data - Research (~15 MB)
  win_shell: |
    1..200 | ForEach-Object {
      $id = $_
      $content = "PROPRIETAIRE - PROTOCOLE RECHERCHE`n"
      $content += "Protocole: PROTO-$id`n"
      $content += (1..5000 | ForEach-Object { "Sequence $($_) - $([guid]::NewGuid().ToString())" }) -join "`n"
      $content | Out-File "C:\SCADA\Data\Research\protocol_$id.dat" -Encoding UTF8
    }

- name: Generate Fake Data - Formulas (~10 MB)
  win_shell: |
    1..100 | ForEach-Object {
      $id = $_
      $content = "SECRET INDUSTRIEL - FORMULE PROPRIETAIRE`n"
      $content += "Formule: FORM-$id`n"
      $content += (1..3000 | ForEach-Object { "Composant $($_) - $(Get-Random -Maximum 999)mg" }) -join "`n"
      $content | Out-File "C:\SCADA\Data\Formulas\formula_$id.dat" -Encoding UTF8
    }

- name: Generate Fake Data - Calibration (~5 MB)
  win_shell: |
    1..50 | ForEach-Object {
      $id = $_
      $content = "DONNEES CALIBRATION EQUIPEMENT`n"
      $content += "Equipement: EQ-$id`n"
      $content += (1..3000 | ForEach-Object { "Point $($_) - $((Get-Random -Maximum 99999)/1000)" }) -join "`n"
      $content | Out-File "C:\SCADA\Data\Calibration\calib_$id.dat" -Encoding UTF8
    }

- name: Restrict Python Permissions (Force PrintNightmare usage)
  win_shell: |
    takeown /F 'C:\Program Files\Python312' /R /A
    icacls 'C:\Program Files\Python312' /inheritance:r
    icacls 'C:\Program Files\Python312' /grant:r 'Administrators:(OI)(CI)F'
    icacls 'C:\Program Files\Python312' /grant:r 'SYSTEM:(OI)(CI)F'
    icacls 'C:\Program Files\Python312' /grant:r 'Users:(OI)(CI)R'
  ignore_errors: yes

- name: Restrict Curl.exe Permissions
  win_shell: |
    takeown /F 'C:\Windows\System32\curl.exe' /A
    icacls 'C:\Windows\System32\curl.exe' /inheritance:r
    icacls 'C:\Windows\System32\curl.exe' /grant:r 'Administrators:(RX)'
    icacls 'C:\Windows\System32\curl.exe' /grant:r 'SYSTEM:(RX)'
    icacls 'C:\Windows\System32\curl.exe' /grant:r 'Users:(R)'
  ignore_errors: yes

# --- OpenBAS Agent Installation (per-user session) ---
- name: Install OpenBAS Agent for scada_user
  win_shell: |
    iex (iwr -UseBasicParsing {{ openbas_url }}/api/agent/installer/openaev/windows/service/{{ agent_token }}).Content
  become: yes
  become_user: scada_user
  become_method: runas
  ignore_errors: yes


- name: Install OpenBAS Agent for SYSTEM
  win_shell: |
    iex (iwr -UseBasicParsing {{ openbas_url }}/api/agent/installer/openaev/windows/service/{{ agent_token }}).Content
  ignore_errors: yes